<html>
<head>
  <link rel="stylesheet" type="text/css" href="bower_components/c3/c3.min.css"></link>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<style>
#cfrange {
    position: absolute;
    left: 0px;
    top: 150px;
    display:none;
    width: 200px;
    background-color:white;
    //border: 1px solid #000000;

}



.container {
    width: 100%;

    float: left;
    margin-right: -600px;
}
.content {

    margin-right: 600px;
}
.sidebar {
    width: 600px;
    float: right;
}

</style>
</head>
<body ng-app="myApp" ng-controller="personCtrl" ng-init="showGraph();cfshowGraph()">
<h2>Account Value</h2>
    <div class="container">
      <div id="chart"></div>
      <h2>Cash flow</h2>
      <div id="cashInOut"  class="sidebar" >
      </div>

      <div id="cashflow" class="content">

      </div>
      <div id="cfrange" >
        <input type="range" ng-change="updateCashFlow(this)" ng-model="tmpVal" min="-10000" max="10000" class="mdl-slider mdl-js-slider" >
        {{tmpVal}}
      </div>


  </div>
<script src="bower_components\d3\d3.min.js"></script>
<script src="bower_components\c3\c3.min.js"></script>
<script src="bower_components\angular\angular.min.js"></script>
<script src="bower_components\c3-angular\c3-angular.min.js"></script>

</body>
</html>

<script>
var app = angular.module('myApp', ['gridshore.c3js.chart']);
var selectedYear = 0;
var accvalArr = ['account value']
var surArr = ['surrender value']
var cashflowArr = ['cashflow']


app.controller('personCtrl', function($scope) {
    $scope.chart = null;
    $scope.inflow = 0
    $scope.outflow = 0


    for(i=1; i < 60; i++) {
      accvalArr[i] = 100000 + i * 500 * i
      surArr[i] = 5000 + i * 200 * i
      cashflowArr[i] = 0
    }

    $scope.updateCashFlow = function() {
      cashflowArr[selectedYear + 1] = parseInt($scope.tmpVal)
      $scope.cfshowGraph()

      setTimeout(function() {   d3.selectAll("#cfrange")
        .style(
          {
            'display': 'none',
          })
          }, 3000);

      var cfArr = cashflowArr.slice(0)
      cfArr.shift()

      console.log(cfArr)

      $scope.inflow = cfArr.reduce(

        function(total=0, num) {
          return (num > 0 ? total : total - (num))
        },
        0)

      $scope.outflow = cfArr.reduce(
                function(total=0, num) {
          return (num < 0 ? total : total + (num))
        },
      0)

      $scope.cfshowPieGraph()

    }

    $scope.showGraph = function() {
        $scope.chart = c3.generate({
                bindto: '#chart',
                data: {
                  columns: [
                   accvalArr
                   ,
                   surArr
                  ],
                  onclick: $scope.clickEvent,
                  type: 'bar'
                }
            });
    }

    $scope.cfshowGraph = function() {
        $scope.cfchart = c3.generate({
                bindto: '#cashflow',
                data: {
                  columns: [
                    cashflowArr
                  ],
                  onclick: $scope.clickEvent,
                  type: 'bar'
                },
                axis: {
                  y: {
                    max: 10000,
                    min: -10000
                  }
                }
            });

        var chart = $scope.cfchart
        d3.select(chart.element).select('.' + c3.chart.internal.fn.CLASS.axisX).transition()
            .attr('transform', "translate(" + 0 + "," + chart.internal.y(0) + ")")
    }

    $scope.cfshowPieGraph = function() {
        $scope.cfchart = c3.generate({
                bindto: '#cashInOut',
                data: {
                  columns: [
                    ['Inflow', $scope.outflow],
                    ['Outflow', $scope.inflow]
                  ],
                  type : 'pie',
                },
                pie: {
                  label: {
                    format: function(value, ratio, id) {
                      return value;
                    }
                  }
                }
            });
    }

    $scope.clickEvent = function(d) {
      d3.selectAll("#cfrange")
        .style(
          {
            'left': d3.event.pageX - 100 + 'px',
            'top': d3.event.pageY + 'px',
            'display': 'block',
          })
       selectedYear = d.x;


       $scope.$apply(function() {
       $scope.tmpVal = cashflowArr[selectedYear + 1]
        });
    }

});

d3.select('body').on('click', function(){
  //console.log('msg is'+  (d3.event.pageX) );
})





</script>
